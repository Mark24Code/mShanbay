{% extends "content_base.html" %}
{% block css %}
    <style>
    body{
        background: #eee;;
    }
    .card_container{
        margin: 0 10px;
    }
    .progress_info{
        border: 1px solid #44B78B;
        border-radius: 2px;
        margin-bottom: 10px;
        background: #44B78B;
    }
    .progress_info .xui-plan{
        text-align: center;
    }

    .xui-card{
        border-radius: 2px;
        background-color: #44B78B;
        color: white;

    }
    .xui-card .xui-word{
        border-radius: 2px;
        background-color:#0C4B33;
        padding: 1rem 2rem;
        text-align: left;

    }
    .xui-card .xui-meaning{
        border-radius: 2px;
        padding: 1rem 2rem;
        text-align: left;
    }

    .xui-card .xui-synonym{
        background-color: #8BD2A2;
        border-radius: 2px;
        padding: 1rem 2rem;
        text-align: left;
    }
    .xui-footer{
        width: 100%;
        position: fixed;
        bottom: 0;
        background: black;
        opacity: 0.8;
        text-align: center;
        padding: 0.8rem 0;
    }
    #note_modal{
        color:#676C5E;
    }
    .xui-is_shared{
        float: left;
    }
    </style>
{% endblock %}

{% block content_base %}
<div class="card_container">
    <div class="progress">
      <div id="progress-bar" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
      </div>
    </div>
    <div class="progress_info">
        <h4 class="xui-plan">
            计划总数<span class="xa-count">0</span>
            已完成<span class="xa-index">0</span>
        </h4>
    </div>
    <div id="card_handlebars_container" class="xui-card"></div>
</div>
<div id="footer" class="xui-footer">
    <div class="xui-note_list">
        <span class="fa fa-comments-o fa-2x col-xs-4" aria-hidden="true"></span>
    </div>
    <div class="xui-collect">
        <span class="fa fa-star-o fa-2x col-xs-4" aria-hidden="true"></span>
    </div>
    <div class="xui-add_note xa-add_note">
        <span class="fa fa-commenting-o fa-2x col-xs-4" aria-hidden="true"></span>
    </div>
</div>

<div class="modal fade" id="note_modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">笔记</h4>
      </div>
      <div class="modal-body">
        <textarea id="note_content" name="note_content" class="form-control" rows="6"></textarea>
      </div>
      <div class="modal-footer">
        <div  class="checkbox xui-is_shared xa-is_shared">
            <label>
              <input id="is_shared" type="checkbox" checked>分享
            </label>
        </div>
        <button id="btn-cancel" type="button" class="btn btn-default xa-cancel" data-dismiss="modal">取消</button>
        <button id='btn-save' type="button" class="btn btn-primary xa-save">保存</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block js %}
    <script type="text/javascript" src="/static/touchSwipe/jquery.touchSwipe.min.js"></script>
    {% verbatim %}
    <script id="card-template" type="text/x-handlebars-template">
    <div id="card" class="xui-card">
        <div id="word" class="xui-word"><h2>{{ word }}</h2></div>
        <div id="meaning" class="xui-meaning">【释义】 {{ meaning }}</div>
        {{#if synonym}}
            <div id="synonym" class="xui-synonym">【近义词】 {{ synonym }}</div>
        {{/if}}
    </div>
    </script>
    {% endverbatim %}
    <script type="text/javascript">
        function Cards(el_id,temple_id) {
            this.el_id = el_id;
            this.temple_id =temple_id;
            this.cards_data = [];
            this.card_data="";
            this.count = 0;
            this.group_index = 0;
            this.index = 0;
        }

        Cards.prototype.init = function() {
            this.get_card_datas();
            this.get_cur_card();
        };
        Cards.prototype.get_progress = function(){
            return;
        }
        Cards.prototype.get_card_datas = function() {
            $.ajax({
                url: '/eating/',
                type: 'get',
                async:false,
                data: {
                    '_method': 'get'
                },
                success: function(resp) {
                    cards.cards_data = resp.data.items;
                    cards.count = resp.data.count;
                    cards.group_index = resp.data.group_index;

                    console.log('success');
                    console.log(resp.data.items);
                },
                error: function(resp) {
                    console.log("[CARDS] GET DATA FAIL");
                }
            });
        }

        Cards.prototype.get_cur_card = function(){
            this.card_data = this.cards_data[this.index];
            this.render(this.card_data,this.el_id,this.temple_id);
        }

        Cards.prototype.get_next_card = function(){
            if( this.index < this.cards_data.length-1){
                this.index += 1;
                this.card_data = this.cards_data[this.index];
                this.render(this.card_data,this.el_id,this.temple_id);
            }else {
                this.index = this.cards_data.length -1;
            }
        }

        Cards.prototype.get_prev_card = function(){
            if( this.index > 0){
                this.index -= 1;
                this.card_data = this.cards_data[this.index];
                this.render(this.card_data,this.el_id,this.temple_id);
            }else {
                this.index = 0;
            }
        }

        Cards.prototype.render = function(card_data,el_id,temple_id) {
            console.log('render.....');
            var temple = $('#'+temple_id).html();
            var compile_temple = Handlebars.compile(temple);
            var temple_html = compile_temple(card_data);
            $('#'+el_id).html(temple_html);
        };

        function update_prograss(cards){
            $('.xa-index').html(parseInt(cards.index)+1);
            var percent = ""+((parseInt(cards.index)+1)/parseInt(cards.count)*100).toFixed(1)+"%";
            $('#progress-bar').css("width",percent);
        }

        $(document).ready(function () {
            //init
            cards = new Cards('card_handlebars_container','card-template');
            cards.init();
            $('.xa-count').html(cards.count);
            $('.xa-index').html(parseInt(cards.index)+1);
            //swipe
            $(function() {
                $("#card_handlebars_container").swipe( {
                    swipeLeft:function(event, direction, distance, duration, fingerCount) {
                        cards.get_next_card();
                        update_prograss(cards);

                    },
                    swipeRight:function(event, direction, distance, duration, fingerCount) {
                        cards.get_prev_card();
                        update_prograss(cards);
                    },
                    //Default is 75px, set to 0 for demo so any distance triggers swipe
                    threshold:0
                });
            });

            //footer
            $('.xa-add_note').click(function(){
                $('#note_modal').modal();
            });
            $('.xa-cancel').click(function(){
                $('#note_content').val("");
            });
            $('.xa-save').click(function(){
                var word_id = cards.cards_data[cards.index].id;
                var note_content = $("#note_content").val();
                var is_shared = $('#is_shared').prop("checked");

                $.ajax({
                    url: '/eating/note/api/',
                    type: 'post',
                    async:false,
                    data: {
                        '_method': 'put',
                        'word_id':word_id,
                        'note_content':note_content,
                        'is_shared':is_shared
                    },
                    success: function(resp) {
                        console.log('[NOTE] 创建笔记成功');
                    },
                    error: function(resp) {
                        console.log("[NOTE] 创建笔记失败");
                    }
                });

                $('.xa-cancel').click();
            });
        });


    </script>
{% endblock %}
